name: Automated Release

on:
  workflow_dispatch:
    inputs:
      gitRef:
        description: Commit SHA, tag or branch name (usually main branch)
        required: true
        default: "main"
        type: string
      version:
        description: Release version (semver without v prefix, e.g. 0.1.0)
        required: true
        type: string

jobs:
  prepare-release:
    name: Prepare release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code at git ref
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.gitRef }}
          token: ${{ secrets.KUADRANT_DEV_PAT }}

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "Error: Version '$VERSION' is not valid semver format (expected: X.Y.Z or X.Y.Z-suffix)"
            exit 1
          fi
          echo "Version $VERSION is valid"

      - name: Create release branch
        id: create-release-branch
        run: |
          base_branch=release-v$(echo "${{ github.event.inputs.version }}" | sed 's/[+-].*//; s/\.[0-9]*$//')
          echo "BASE_BRANCH=$base_branch" >> $GITHUB_ENV

          if git ls-remote --exit-code --heads origin $base_branch; then
            echo "Base branch $base_branch already exists"
            git fetch origin $base_branch
            git checkout $base_branch
          else
            echo "Creating branch $base_branch"
            git checkout -b "$base_branch"
            git push --set-upstream origin "$base_branch"
          fi

      - name: Update VERSION in Makefile
        run: |
          VERSION="${{ github.event.inputs.version }}"
          sed -i "s/^VERSION ?= .*/VERSION ?= $VERSION/" Makefile

          echo "Updated Makefile VERSION to $VERSION"
          grep "^VERSION" Makefile

      - name: Create Pull Request
        if: ${{ !env.ACT }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.KUADRANT_DEV_PAT }}
          commit-message: "Release v${{ github.event.inputs.version }}"
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
          signoff: true
          base: ${{ env.BASE_BRANCH }}
          branch: release-v${{ github.event.inputs.version }}
          delete-branch: true
          title: "[Release] Developer Portal Controller v${{ github.event.inputs.version }}"
          body: |
            Prepare release v${{ github.event.inputs.version }}

            ## Changes
            - Updated VERSION in Makefile to ${{ github.event.inputs.version }}

            ## Post-merge
            After this PR is merged, a workflow will automatically:
            - Create git tag v${{ github.event.inputs.version }}
            - Create GitHub release
            - Build and push image to quay.io

            Auto-generated by [create-pull-request](https://github.com/peter-evans/create-pull-request)
          team-reviewers: |
            Kuadrant/developers
          draft: false
